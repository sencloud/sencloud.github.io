"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[408],{8698:(e,t,a)=>{a.d(t,{mR:()=>I,B:()=>S,y8:()=>_,_z:()=>u,dF:()=>E,y$:()=>k,JX:()=>w,Tu:()=>v,s1:()=>y,Pj:()=>g});var n=a(45443),s=a(94340),r=a(65942),o=a(40439),l=a(41773),i=a(23970),c=a(27292);let d=(0,n.Ak)(),g=(0,r.v)(e=>({responding:!1,threadId:d,messageIds:[],messages:new Map,researchIds:[],researchPlanIds:new Map,researchReportIds:new Map,researchActivityIds:new Map,ongoingResearchId:null,openResearchId:null,userId:null,appendMessage(t){e(e=>({messageIds:[...e.messageIds,t.id],messages:new Map(e.messages).set(t.id,t)}))},updateMessage(t){e(e=>({messages:new Map(e.messages).set(t.id,t)}))},updateMessages(t){e(e=>{let a=new Map(e.messages),n=[...e.messageIds];return t.forEach(e=>{a.set(e.id,e),n.includes(e.id)||n.push(e.id)}),{messages:a,messageIds:n}})},openResearch(t){e({openResearchId:t})},closeResearch(){e({openResearchId:null})},setOngoingResearch(t){e({ongoingResearchId:t})},setUserId(t){e({userId:t})}}));async function u(e){var t,a,r;let o,{interruptFeedback:i,chatId:u}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},I=g.getState().userId;if(console.log("Sending message, current userId:",I),console.log("Current store state:",g.getState()),!I){console.log("No userId found, showing login message"),s.oR.error("Please login first");return}null!=e&&f({id:(0,n.Ak)(),threadId:u||d,role:"user",content:e,contentChunks:[e]});let S=(0,c.qU)(),y=(0,l.NZ)(null!=e?e:"[REPLAY]",{thread_id:u||d,interrupt_feedback:i,auto_accepted_plan:S.autoAcceptedPlan,enable_background_investigation:null==(t=S.enableBackgroundInvestigation)||t,max_plan_iterations:S.maxPlanIterations,max_step_num:S.maxStepNum,mcp_settings:S.mcpSettings,user_id:I},_);h(!0);try{for await(let e of y){let t,{type:n,data:s}=e;o=s.id,"tool_call_result"===n?t=function(e){return Array.from(g.getState().messages.values()).reverse().find(t=>!!t.toolCalls&&t.toolCalls.some(t=>t.id===e))}(s.tool_call_id):(a=o,g.getState().messageIds.includes(a)||(t={id:o,threadId:s.thread_id,agent:s.agent,role:s.role,content:"",contentChunks:[],isStreaming:!0,interruptFeedback:i},f(t))),null!=t||(t=p(o)),t&&(r=t=function(e,t){var a,n,s,r;return"message_chunk"===t.type?(a=e,(n=t).data.content&&(a.content+=n.data.content,a.contentChunks.push(n.data.content))):"tool_calls"===t.type||"tool_call_chunks"===t.type?function(e,t){var a,n;for(let n of("tool_calls"===t.type&&(null==(a=t.data.tool_calls[0])?void 0:a.name)&&(e.toolCalls=t.data.tool_calls.map(e=>({id:e.id,name:e.name,args:e.args,result:void 0}))),null!=e.toolCalls||(e.toolCalls=[]),t.data.tool_call_chunks))if(n.id){let t=e.toolCalls.find(e=>e.id===n.id);t&&(t.argsChunks=[n.args])}else{let t=e.toolCalls.find(e=>{var t;return null==(t=e.argsChunks)?void 0:t.length});t&&t.argsChunks.push(n.args)}}(e,t):"tool_call_result"===t.type?function(e,t){var a;let n=null==(a=e.toolCalls)?void 0:a.find(e=>e.id===t.data.tool_call_id);n&&(n.result=t.data.content)}(e,t):"interrupt"===t.type&&(s=e,r=t,s.isStreaming=!1,s.options=r.data.options),t.data.finish_reason&&(e.finishReason=t.data.finish_reason,e.isStreaming=!1,e.toolCalls&&e.toolCalls.forEach(e=>{var t;(null==(t=e.argsChunks)?void 0:t.length)&&(e.args=JSON.parse(e.argsChunks.join("")),delete e.argsChunks)})),JSON.parse(JSON.stringify(e))}(t,e),m()&&"reporter"===r.agent&&!r.isStreaming&&g.getState().setOngoingResearch(null),g.getState().updateMessage(r))}}catch(e){if((0,s.oR)("An error occurred while generating the response. Please try again."),null!=o){let e=p(o);(null==e?void 0:e.isStreaming)&&(e.isStreaming=!1,g.getState().updateMessage(e))}g.getState().setOngoingResearch(null)}finally{h(!1)}}function h(e){g.setState({responding:e})}function p(e){return g.getState().messages.get(e)}function f(e){if("coder"===e.agent||"reporter"===e.agent||"researcher"===e.agent){if(!m()){let t=e.id;(function(e){let t;for(let e of[...g.getState().messageIds].reverse()){let a=p(e);if((null==a?void 0:a.agent)==="planner"){t=a;break}}let a=[e];a.unshift(t.id),g.setState({ongoingResearchId:e,researchIds:[...g.getState().researchIds,e],researchPlanIds:new Map(g.getState().researchPlanIds).set(e,t.id),researchActivityIds:new Map(g.getState().researchActivityIds).set(e,a)})})(t),_(t)}var t=e;let a=m();if(a){let e=g.getState().researchActivityIds,n=e.get(a);n.includes(t.id)||g.setState({researchActivityIds:new Map(e).set(a,[...n,t.id])}),"reporter"===t.agent&&g.setState({researchReportIds:new Map(g.getState().researchReportIds).set(a,t.id)})}}g.getState().appendMessage(e)}function m(){return g.getState().ongoingResearchId}function _(e){g.getState().openResearch(e)}function I(){g.getState().closeResearch()}async function S(e){let t=g.getState().researchPlanIds.get(e),a=g.getState().researchReportIds.get(e);if(t&&a){let r=p(t),o=(0,i.Ol)(r.content,{title:"Untitled"}).title,c=p(a);if(null==c?void 0:c.content){let t;f({id:(0,n.Ak)(),threadId:d,role:"user",content:"Please generate a podcast for the above research.",contentChunks:[]});let a=(0,n.Ak)(),r={title:o,researchId:e};f({id:a,threadId:d,role:"assistant",agent:"podcast",content:JSON.stringify(r),contentChunks:[],isStreaming:!0});try{t=await (0,l.CP)(c.content)}catch(e){console.error(e),g.setState(t=>({messages:new Map(g.getState().messages).set(a,{...t.messages.get(a),content:JSON.stringify({...r,error:e instanceof Error?e.message:"Unknown error"}),isStreaming:!1})})),(0,s.oR)("An error occurred while generating podcast. Please try again.");return}g.setState(e=>({messages:new Map(g.getState().messages).set(a,{...e.messages.get(a),content:JSON.stringify({...r,audioUrl:t}),isStreaming:!1})}))}}}function y(e){return g((0,o.k)(t=>{let a=t.researchPlanIds.get(e);return a?t.messages.get(a):void 0}))}function w(e){return g((0,o.k)(t=>e?t.messages.get(e):void 0))}function v(){return g((0,o.k)(e=>e.messageIds))}function k(){return g((0,o.k)(e=>{if(e.messageIds.length>=2){let t=e.messages.get(e.messageIds[e.messageIds.length-1]);return(null==t?void 0:t.finishReason)==="interrupt"?t:null}return null}))}function E(){return g((0,o.k)(e=>{if(e.messageIds.length>=2){let t=e.messages.get(e.messageIds[e.messageIds.length-1]);if(t&&"interrupt"===t.finishReason)return e.messageIds[e.messageIds.length-2]}return null}))}},9260:(e,t,a)=>{a.d(t,{$:()=>s});var n=a(47684);function s(e){var t;let a=null!=(t=n._.NEXT_PUBLIC_API_URL)?t:"http://localhost:8000/api/";return a.endsWith("/")||(a+="/"),new URL(e,a).toString()}},10141:(e,t,a)=>{a.d(t,{w:()=>n});function n(e){let t=new URLSearchParams(e);return t.has("replay")?t.get("replay"):null}},23970:(e,t,a)=>{function n(e){return new Promise(t=>setTimeout(t,e))}a.d(t,{Ol:()=>r,yy:()=>n});var s=a(66985);function r(e,t){if(!e)return t;try{let t=e.trim().replace(/^```json\s*/,"").replace(/^```\s*/,"").replace(/\s*```$/,"");return(0,s.q)(t)}catch(e){return t}}},27292:(e,t,a)=>{a.d(t,{C$:()=>o,DZ:()=>i,Qk:()=>d,kz:()=>l,qU:()=>c});var n=a(65942);let s="deerflow.settings",r={general:{autoAcceptedPlan:!1,enableBackgroundInvestigation:!1,maxPlanIterations:1,maxStepNum:3},mcp:{servers:[]}},o=(0,n.v)(()=>({...r})),l=e=>{o.setState(e)},i=()=>{let e=JSON.stringify(o.getState());localStorage.setItem(s,e)},c=()=>{let e,{mcp:t,general:a}=o.getState(),n=t.servers.filter(e=>e.enabled);return n.length>0&&(e={servers:n.reduce((e,t)=>{let a,{transport:n,env:s}=t;return a="stdio"===n?{name:t.name,transport:n,env:s,command:t.command,args:t.args}:{name:t.name,transport:n,env:s,url:t.url},{...e,[t.name]:{...a,enabled_tools:t.tools.map(e=>e.name),add_to_agents:["researcher"]}}},{})}),{...a,mcpSettings:e}};function d(e){o.setState(t=>({general:{...t.general,enableBackgroundInvestigation:e}})),i()}(()=>{let e=localStorage.getItem(s);if(e){let t=JSON.parse(e);for(let e in r.general)e in t.general||(t.general[e]=r.general[e]);try{o.setState(t)}catch(e){console.error(e)}}})()},41773:(e,t,a)=>{a.d(t,{NZ:()=>n.NZ,DU:()=>n.DU,CP:()=>o,Bf:()=>r});var n=a(62132),s=a(9260);async function r(e){let t=await fetch((0,s.$)("mcp/server/metadata"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));return t.json()}async function o(e){let t=await fetch((0,s.$)("podcast/generate"),{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e})});if(!t.ok)throw Error("HTTP error! status: ".concat(t.status));let a=new Blob([await t.arrayBuffer()],{type:"audio/mp3"});return URL.createObjectURL(a)}},47684:(e,t,a)=>{a.d(t,{_:()=>o});var n=a(19305),s=a(9453),r=a(96133);let o=(0,n.w)({server:{NODE_ENV:s.z.enum(["development","test","production"]),AMPLITUDE_API_KEY:s.z.string().optional(),GITHUB_OAUTH_TOKEN:s.z.string().optional()},client:{NEXT_PUBLIC_API_URL:s.z.string().optional(),NEXT_PUBLIC_STATIC_WEBSITE_ONLY:s.z.boolean().optional()},runtimeEnv:{NODE_ENV:"production",NEXT_PUBLIC_API_URL:r.env.NEXT_PUBLIC_API_URL,NEXT_PUBLIC_STATIC_WEBSITE_ONLY:"true"===r.env.NEXT_PUBLIC_STATIC_WEBSITE_ONLY,AMPLITUDE_API_KEY:r.env.AMPLITUDE_API_KEY,GITHUB_OAUTH_TOKEN:r.env.GITHUB_OAUTH_TOKEN},skipValidation:!!r.env.SKIP_ENV_VALIDATION,emptyStringAsUndefined:!0})},62132:(e,t,a)=>{a.d(t,{DU:()=>f,M0:()=>u,NZ:()=>i});var n=a(47684),s=a(10141),r=a(90598),o=a(23970),l=a(9260);async function*i(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n._.NEXT_PUBLIC_STATIC_WEBSITE_ONLY||location.search.includes("mock")||location.search.includes("replay="))return yield*c(e,t,a);if(!t.user_id)throw Error("User authentication required");for await(let n of(0,r.x)((0,l.$)("chat/stream"),{body:JSON.stringify({messages:[{role:"user",content:e}],...t}),signal:a.abortSignal}))yield{type:n.event,data:JSON.parse(n.data)}}async function*c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{thread_id:"__mock__",auto_accepted_plan:!1,max_plan_iterations:3,max_step_num:1,interrupt_feedback:void 0},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=new URLSearchParams(window.location.search),r="";if(n.has("mock"))r=n.get("mock")?"/mock/".concat(n.get("mock"),".txt"):"accepted"===t.interrupt_feedback?"/mock/final-answer.txt":"edit_plan"===t.interrupt_feedback?"/mock/re-plan.txt":"/mock/first-plan.txt",p=!0;else{let e=(0,s.w)(window.location.search);r=e?"/replay/".concat(e,".txt"):"/replay/eiffel-tower-vs-tallest-building.txt"}for(let e of(await g(r,{abortSignal:a.abortSignal})).split("\n\n")){let[t,a]=e.split("\n"),[,n]=t.split("event: ",2),[,s]=a.split("data: ",2);try{let e={type:n,data:JSON.parse(s)};"message_chunk"===e.type?e.data.finish_reason||await h(50):"tool_call_result"===e.type&&await h(500),yield e,"tool_call_result"===e.type?await h(800):"message_chunk"===e.type&&"user"===e.data.role&&await h(500)}catch(e){console.error(e)}}}let d=new Map;async function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(d.has(e))return d.get(e);let a=await fetch(e,{signal:t.abortSignal});if(!a.ok)throw Error("Failed to fetch replay: ".concat(a.statusText));let n=await a.text();return d.set(e,n),n}async function u(){for await(let e of c("",{thread_id:"__mock__",auto_accepted_plan:!1,max_plan_iterations:3,max_step_num:1},{}))if("message_chunk"===e.type)return e.data.content}async function h(e){p?await (0,o.yy)(0):await (0,o.yy)(e)}let p=!1;function f(e){p=e}},65408:(e,t,a)=>{a.d(t,{n:()=>c});var n=a(65942),s=a(9260);async function r(e,t){let a=new FormData;a.append("username",e),a.append("password",t);let n=await fetch((0,s.$)("auth/token"),{method:"POST",body:a});if(!n.ok)throw Error((await n.json()).detail||"登录失败");let r=await n.json();return localStorage.setItem("auth_token",r.access_token),r}async function o(e,t,a){let n=await fetch((0,s.$)("auth/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,email:t,password:a})});if(!n.ok){var r;let e=await n.json();throw Error(Array.isArray(e.detail)?(null==(r=e.detail[0])?void 0:r.msg)||"注册失败":e.detail||"注册失败")}return await n.json()}async function l(){let e=localStorage.getItem("auth_token");if(!e)throw Error("未登录");let t=await fetch((0,s.$)("auth/me"),{headers:{Authorization:"Bearer ".concat(e)}});if(!t.ok){if(401===t.status)throw localStorage.removeItem("auth_token"),Error("登录已过期");throw Error("获取用户信息失败")}return await t.json()}var i=a(8698);let c=(0,n.v)(e=>({user:null,isLoading:!1,error:null,isAuthenticated:!1,login:async(t,a)=>{e({isLoading:!0,error:null});try{console.log("Attempting to login...");let n=await r(t,a);console.log("Login successful, got response:",n),console.log("Getting user info...");let s=await l();console.log("Got user info:",s);let o={...s,id:n.id};e({user:o,isAuthenticated:!0,error:null}),console.log("Setting user ID in store:",o.id),i.Pj.getState().setUserId(o.id),console.log("Login process complete")}catch(t){throw console.error("Login failed:",t),e({error:t instanceof Error?t.message:"登录失败"}),t}finally{e({isLoading:!1})}},register:async(t,a,n)=>{e({isLoading:!0,error:null});try{await o(t,a,n),e({error:null})}catch(t){throw e({error:t instanceof Error?t.message:"注册失败"}),t}finally{e({isLoading:!1})}},logout:()=>{console.log("Logging out..."),localStorage.removeItem("auth_token"),e({user:null,isAuthenticated:!1}),i.Pj.getState().setUserId(null),console.log("Logout complete")},checkAuth:async()=>{e({isLoading:!0});try{console.log("Checking auth status...");let t=await l();if(console.log("User is authenticated:",t),!t.id)throw console.log("No user ID found in response, cannot proceed"),Error("No user ID found");e({user:t,isAuthenticated:!0,error:null}),i.Pj.getState().setUserId(t.id),console.log("Auth check complete, user ID set:",t.id)}catch(t){console.log("Auth check failed:",t),e({user:null,isAuthenticated:!1}),i.Pj.getState().setUserId(null)}finally{e({isLoading:!1})}}}))},90598:(e,t,a)=>{async function*n(e,t){var a;let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"},...t});if(200!==n.status)throw Error("Failed to fetch from ".concat(e,": ").concat(n.status));let s=null==(a=n.body)?void 0:a.pipeThrough(new TextDecoderStream).getReader();if(!s)throw Error("Response body is not readable");let r="";for(;;){let{done:e,value:t}=await s.read();if(e)break;for(r+=t;;){let e=r.indexOf("\n\n");if(-1===e)break;let t=r.slice(0,e);r=r.slice(e+2);let a=function(e){let t="message",a=null;for(let n of e.split("\n")){let e=n.indexOf(": ");if(-1===e)continue;let s=n.slice(0,e),r=n.slice(e+2);"event"===s?t=r:"data"===s&&(a=r)}if("message"!==t||null!==a)return{event:t,data:a}}(t);a&&(yield a)}}}a.d(t,{x:()=>n})}}]);